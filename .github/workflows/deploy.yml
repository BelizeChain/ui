name: Deploy UI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: deploy-ui-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: belizechainregistry.azurecr.io

jobs:
  # ── 1. Test & Lint ─────────────────────────────────────
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18
      - run: npm ci
      - run: npx turbo run lint
      - run: npx turbo run test || true

  # ── 2. Build & Push (both apps) ────────────────────────
  build:
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      matrix:
        include:
          - target: portal
            image: blue-hole-portal
          - target: wallet
            image: maya-wallet
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ matrix.image }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest

      - uses: docker/build-push-action@v5
        with:
          context: .
          target: ${{ matrix.target }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ matrix.image }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ matrix.image }}:buildcache,mode=max

  # ── 3. Deploy ──────────────────────────────────────────
  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Deploy to VM
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            set -e

            REGISTRY="belizechainregistry.azurecr.io"

            # Ensure shared network exists
            docker network create belizechain-net 2>/dev/null || true

            # Login to ACR
            echo "${{ secrets.ACR_PASSWORD }}" | docker login $REGISTRY \
              -u "${{ secrets.ACR_USERNAME }}" --password-stdin

            # Pull both images
            docker pull $REGISTRY/blue-hole-portal:latest
            docker pull $REGISTRY/maya-wallet:latest

            # ── Deploy blue-hole-portal ──
            docker stop blue-hole-portal 2>/dev/null && docker rm blue-hole-portal 2>/dev/null || true
            docker run -d \
              --name blue-hole-portal \
              --network belizechain-net \
              --restart unless-stopped \
              -p 3000:3000 \
              -e NEXT_PUBLIC_BLOCKCHAIN_WS="ws://${{ secrets.VM_HOST }}:9944" \
              -e NEXT_PUBLIC_PAKIT_API="http://${{ secrets.VM_HOST }}:8001" \
              -e NEXT_PUBLIC_KINICH_API="http://${{ secrets.VM_HOST }}:8081" \
              -e NEXT_PUBLIC_NAWAL_API="http://${{ secrets.VM_HOST }}:8002" \
              $REGISTRY/blue-hole-portal:latest

            # ── Deploy maya-wallet ──
            docker stop maya-wallet 2>/dev/null && docker rm maya-wallet 2>/dev/null || true
            docker run -d \
              --name maya-wallet \
              --network belizechain-net \
              --restart unless-stopped \
              -p 3001:3001 \
              -e NEXT_PUBLIC_BLOCKCHAIN_WS="ws://${{ secrets.VM_HOST }}:9944" \
              -e NEXT_PUBLIC_PAKIT_API="http://${{ secrets.VM_HOST }}:8001" \
              $REGISTRY/maya-wallet:latest

            # Health checks
            echo "Waiting for UI containers to become healthy..."
            HEALTHY=true

            for svc in "blue-hole-portal:3000" "maya-wallet:3001"; do
              NAME="${svc%%:*}"
              PORT="${svc##*:}"
              echo "Checking $NAME on port $PORT..."
              OK=false
              for i in $(seq 1 15); do
                if curl -sf http://localhost:$PORT > /dev/null 2>&1; then
                  echo "  ✅ $NAME is healthy"
                  OK=true
                  break
                fi
                echo "  Attempt $i/15 — waiting 5s..."
                sleep 5
              done
              if [ "$OK" = false ]; then
                echo "  ❌ $NAME failed health check"
                docker logs --tail 30 $NAME
                HEALTHY=false
              fi
            done

            if [ "$HEALTHY" = false ]; then
              exit 1
            fi
            echo "✅ All UI containers healthy"
